<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title><![CDATA[CCNP学习心得之双出口NAT]]></title>
    <url>%2F2018%2F03%2F16%2FCCNP%E5%AD%A6%E4%B9%A0%E5%BF%83%E5%BE%97%E4%B9%8B%E5%8F%8C%E5%87%BA%E5%8F%A3NAT%2F</url>
    <content type="text"><![CDATA[第一次写博客，发个最近做的CCNP实验水一波。 下图为拓扑结构: 实验需求为：内网的172.16.1.1访问外网走上面的链路，192.168.1.1访问外网走下面的链路。当其中一条链路出故障时，可以自动切换线路使得上网不受影响。 先配置IP地址和OSPF：R1：12345678910int f0/0ip add 10.12.12.1 255.255.255.0no shutdownip ospf 1 area 0 #接口下启用OSPFint loopback 1ip add 172.16.1.1 255.255.255.0ip ospf 1 area 0int loopback 2ip add 192.168.1.1 255.255.255.0ip ospf 1 area 0 R2：12345678910int f0/0ip add 10.12.12.2 255.255.255.0no shutdownip ospf 1 area 0int f1/0ip add 23.23.172.2 255.255.255.0no shutdown int f0/1ip add 23.23.192.2 255.255.255.0no shutdown R3：12345678int f0/1ip add 23.23.172.3 255.255.255.0no shutdown int f0/0ip add 23.23.192.3 255.255.255.0no shutdown int loopback 1ip add 211.1.1.1 255.255.255.252 接下来设置ACL（访问控制列表）匹配流量，再用策略路由调用ACL，将匹配到的流量送到相应的接口。设置两个下一跳，当第一条链路故障时第一个下一跳无法到达，可以调用第二个，防止断网。（两个链路都故障还是回去牵网线吧）R2：12345678910access-list 1 permit 172.16.1.0 0.0.0.255access-list 2 permit 192.168.1.0 0.0.0.255route-map pbr permit 10match ip add 1set ip next-hop 23.23.172.3 23.23.192.3route-map pbr permit 20match ip add 2set ip next-hop 23.23.192.3 23.23.172.3int f0/0ip policy route-map pbr #接口下调用策略路由 现在策略路由已经将流量送到了两个出接口了，这时候调用NAT，将地址转换为公网地址然后才能把流量发出去。 R2：12ip nat inside source route-map nat1 interface f1/0 overload ip nat inside source route-map nat2 interface f0/1 overload 这里的NAT采用PAT（端口多路复用）的方式，首先调用第一条NAT，NAT_1又调用了路由图_1，接下来我们去看路由图_1的内容。 Route-map nat1：123route-map nat1 permit 10match ip address 1 2match interface f1/0 路由图_1的意思是：匹配两个ACL匹配到的流量，再匹配接口f0/1，当流量是允许的流量且接口正常时，满足路由图的条件，此时再去调用nat1进行地址转换。当流量不匹配或者端口异常时，不满足路由图的条件，这样nat1就无法生效，此时调用nat2，从另一正常接口发送流量。 路由图_2也是这样：123route-map nat2 permit 10match ip address 1 2match interface f0/1 调用NAT：123456int f0/0ip nat inside int f1/0ip nat outside int f0/1ip nat outside 在R2上下放默认路由：1default-information originate always 下放默认路由后，R1才能访问外网，否则R1没有路由条目，无法知道到外网的流量如何转发。 在R1上写默认路由也一样：1ip route 0.0.0.0 0.0.0.0 10.12.12.2 此时可以分流： 当R2的f1/0接口关闭后：12int f1/0shutdown 根据现象可以看出已经自动切换路径了。 常见问题]]></content>
      <tags>
        <tag>CCNP</tag>
      </tags>
  </entry>
</search>
